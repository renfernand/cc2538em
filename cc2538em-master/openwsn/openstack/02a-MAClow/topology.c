#include "opendefs.h"
#include "topology.h"
#include "idmanager.h"

//=========================== defines =========================================
/*choose number of motes to simulate 50 or 100 */
#define SIMU_NR_MOTES 100


//=========================== variables =======================================

//=========================== prototypes ======================================

//=========================== public ==========================================

/**
\brief Force a topology.

This function is used to force a certain topology, by hard-coding the list of
acceptable neighbors for a given mote. This function is invoked each time a
packet is received. If it returns FALSE, the packet is silently dropped, as if
it were never received. If it returns TRUE, the packet is accepted.

Typically, filtering packets is done by analyzing the IEEE802.15.4 header. An
example body for this function which forces a topology is:

   switch (idmanager_getMyID(ADDR_64B)->addr_64b[7]) {
      case TOPOLOGY_MOTE1:
         if (ieee802514_header->src.addr_64b[7]==TOPOLOGY_MOTE2) {
            returnVal=TRUE;
         } else {
            returnVal=FALSE;
         }
         break;
      case TOPOLOGY_MOTE2:
         if (ieee802514_header->src.addr_64b[7]==TOPOLOGY_MOTE1 ||
             ieee802514_header->src.addr_64b[7]==TOPOLOGY_MOTE3) {
            returnVal=TRUE;
         } else {
            returnVal=FALSE;
         }
         break;
      default:
         returnVal=TRUE;
   }
   return returnVal;

By default, however, the function should return TRUE to *not* force any
topology.

\param[in] ieee802514_header The parsed IEEE802.15.4 MAC header.

\return TRUE if the packet can be received.
\return FALSE if the packet should be silently dropped.
*/


static const SNeibhboorstable neighboorstable[] =
{ 
#if (SIMU_NR_MOTES == 50)
	{ 1, 3, 2, 11, 12, 0, 0, 0, 0, 0, 0, 0 },
	{ 2, 5, 1, 3, 11, 12, 13, 0, 0, 0, 0, 0 },
	{ 3, 5, 2, 4, 12, 13, 14, 0, 0, 0, 0, 0 },
	{ 4, 5, 3, 5, 13, 14, 15, 0, 0, 0, 0, 0 },
	{ 5, 5, 4, 6, 14, 15, 16, 0, 0, 0, 0, 0 },
	{ 6, 5, 5, 7, 15, 16, 17, 0, 0, 0, 0, 0 },
	{ 7, 5, 6, 8, 16, 17, 18, 0, 0, 0, 0, 0 },
	{ 8, 5, 7, 9, 17, 18, 19, 0, 0, 0, 0, 0 },
	{ 9, 5, 8, 10, 18, 19, 20, 0, 0, 0, 0, 0 },
	{ 10, 3, 9, 19, 20, 0, 0, 0, 0, 0, 0, 0 },
	{ 11, 5, 12, 21, 22, 1, 2, 0, 0, 0, 0, 0 },
	{ 12, 8, 11, 13, 21, 22, 23, 1, 2, 3, 0, 0 },
	{ 13, 8, 12, 14, 22, 23, 24, 2, 3, 4, 0, 0 },
	{ 14, 8, 13, 15, 23, 24, 25, 3, 4, 5, 0, 0 },
	{ 15, 8, 14, 16, 24, 25, 26, 4, 5, 6, 0, 0 },
	{ 16, 8, 15, 17, 25, 26, 27, 5, 6, 7, 0, 0 },
	{ 17, 8, 16, 18, 26, 27, 28, 6, 7, 8, 0, 0 },
	{ 18, 8, 17, 19, 27, 28, 29, 7, 8, 9, 0, 0 },
	{ 19, 8, 18, 20, 28, 29, 30, 8, 9, 10, 0, 0 },
	{ 20, 7, 19, 21, 29, 30, 31, 9, 10, 0, 0, 0 },
	{ 21, 8, 20, 22, 30, 31, 32, 10, 11, 12, 0, 0 },
	{ 22, 8, 21, 23, 31, 32, 33, 11, 12, 13, 0, 0 },
	{ 23, 8, 22, 24, 32, 33, 34, 12, 13, 14, 0, 0 },
	{ 24, 8, 23, 25, 33, 34, 35, 13, 14, 15, 0, 0 },
	{ 25, 8, 24, 26, 34, 35, 36, 14, 15, 16, 0, 0 },
	{ 26, 8, 25, 27, 35, 36, 37, 15, 16, 17, 0, 0 },
	{ 27, 8, 26, 28, 36, 37, 38, 16, 17, 18, 0, 0 },
	{ 28, 8, 27, 29, 37, 38, 39, 17, 18, 19, 0, 0 },
	{ 29, 8, 28, 30, 38, 39, 40, 18, 19, 20, 0, 0 },
	{ 30, 8, 29, 31, 39, 40, 41, 19, 20, 21, 0, 0 },
	{ 31, 8, 30, 32, 40, 41, 42, 20, 21, 22, 0, 0 },
	{ 32, 8, 31, 33, 41, 42, 43, 21, 22, 23, 0, 0 },
	{ 33, 8, 32, 34, 42, 43, 44, 22, 23, 24, 0, 0 },
	{ 34, 8, 33, 35, 43, 44, 45, 23, 24, 25, 0, 0 },
	{ 35, 8, 34, 36, 44, 45, 46, 24, 25, 26, 0, 0 },
	{ 36, 8, 35, 37, 45, 46, 47, 25, 26, 27, 0, 0 },
	{ 37, 8, 36, 38, 46, 47, 48, 26, 27, 28, 0, 0 },
	{ 38, 8, 37, 39, 47, 48, 49, 27, 28, 29, 0, 0 },
	{ 39, 8, 38, 40, 48, 49, 50, 28, 29, 30, 0, 0 },
	{ 40, 8, 39, 41, 49, 50, 51, 29, 30, 31, 0, 0 },
	{ 41, 8, 40, 42, 50, 51, 52, 30, 31, 32, 0, 0 },
	{ 42, 8, 41, 43, 51, 52, 53, 31, 32, 33, 0, 0 },
	{ 43, 8, 42, 44, 52, 53, 54, 32, 33, 34, 0, 0 },
	{ 44, 8, 43, 45, 53, 54, 55, 33, 34, 35, 0, 0 },
	{ 45, 8, 44, 46, 54, 55, 56, 34, 35, 36, 0, 0 },
	{ 46, 8, 45, 47, 55, 56, 57, 35, 36, 37, 0, 0 },
	{ 47, 8, 46, 48, 56, 57, 58, 36, 37, 38, 0, 0 },
	{ 48, 8, 47, 49, 57, 58, 59, 37, 38, 39, 0, 0 },
	{ 49, 8, 48, 50, 58, 59, 60, 38, 39, 40, 0, 0 },
	{ 50, 8, 49, 51, 59, 60, 61, 39, 40, 41, 0, 0 }
#else
  {1,3,2,11,12,0,0,0,0,0,0,0},
  {2,5,1,3,11,12,13,0,0,0,0,0},
  {3,5,2,4,12,13,14,0,0,0,0,0},
  {4,5,3,5,13,14,15,0,0,0,0,0},
  {5,5,4,6,14,15,16,0,0,0,0,0},
  {6,5,5,7,15,16,17,0,0,0,0,0},
  {7,5,6,8,16,17,18,0,0,0,0,0},
  {8,5,7,9,17,18,19,0,0,0,0,0},
  {9,5,8,10,18,19,20,0,0,0,0,0},
  {10,3,9,19,20,0,0,0,0,0,0,0},
  {11,5,12,21,22,1,2,0,0,0,0,0},
  {12,8,11,13,21,22,23,1,2,3,0,0},
  {13,8,12,14,22,23,24,2,3,4,0,0},
  {14,8,13,15,23,24,25,3,4,5,0,0},
  {15,8,14,16,24,25,26,4,5,6,0,0},
  {16,8,15,17,25,26,27,5,6,7,0,0},
  {17,8,16,18,26,27,28,6,7,8,0,0},
  {18,8,17,19,27,28,29,7,8,9,0,0},
  {19,8,18,20,28,29,30,8,9,10,0,0},
  {20,7,19,21,29,30,31,9,10,0,0,0},
  {21,8,20,22,30,31,32,10,11,12,0,0},
  {22,8,21,23,31,32,33,11,12,13,0,0},
  {23,8,22,24,32,33,34,12,13,14,0,0},
  {24,8,23,25,33,34,35,13,14,15,0,0},
  {25,8,24,26,34,35,36,14,15,16,0,0},
  {26,8,25,27,35,36,37,15,16,17,0,0},
  {27,8,26,28,36,37,38,16,17,18,0,0},
  {28,8,27,29,37,38,39,17,18,19,0,0},
  {29,8,28,30,38,39,40,18,19,20,0,0},
  {30,8,29,31,39,40,41,19,20,21,0,0},
  {31,8,30,32,40,41,42,20,21,22,0,0},
  {32,8,31,33,41,42,43,21,22,23,0,0},
  {33,8,32,34,42,43,44,22,23,24,0,0},
  {34,8,33,35,43,44,45,23,24,25,0,0},
  {35,8,34,36,44,45,46,24,25,26,0,0},
  {36,8,35,37,45,46,47,25,26,27,0,0},
  {37,8,36,38,46,47,48,26,27,28,0,0},
  {38,8,37,39,47,48,49,27,28,29,0,0},
  {39,8,38,40,48,49,50,28,29,30,0,0},
  {40,8,39,41,49,50,51,29,30,31,0,0},
  {41,8,40,42,50,51,52,30,31,32,0,0},
  {42,8,41,43,51,52,53,31,32,33,0,0},
  {43,8,42,44,52,53,54,32,33,34,0,0},
  {44,8,43,45,53,54,55,33,34,35,0,0},
  {45,8,44,46,54,55,56,34,35,36,0,0},
  {46,8,45,47,55,56,57,35,36,37,0,0},
  {47,8,46,48,56,57,58,36,37,38,0,0},
  {48,8,47,49,57,58,59,37,38,39,0,0},
  {49,8,48,50,58,59,60,38,39,40,0,0},
  {50,8,49,51,59,60,61,39,40,41,0,0},
  {51,8,50,52,60,61,62,40,41,42,0,0},
  {52,8,51,53,61,62,63,41,42,43,0,0},
  {53,8,52,54,62,63,64,42,43,44,0,0},
  {54,8,53,55,63,64,65,43,44,45,0,0},
  {55,8,54,56,64,65,66,44,45,46,0,0},
  {56,8,55,57,65,66,67,45,46,47,0,0},
  {57,8,56,58,66,67,68,46,47,48,0,0},
  {58,8,57,59,67,68,69,47,48,49,0,0},
  {59,8,58,60,68,69,70,48,49,50,0,0},
  {60,8,59,61,69,70,71,49,50,51,0,0},
  {61,8,60,62,70,71,72,50,51,52,0,0},
  {62,8,61,63,71,72,73,51,52,53,0,0},
  {63,8,62,64,72,73,74,52,53,54,0,0},
  {64,8,63,65,73,74,75,53,54,55,0,0},
  {65,8,64,66,74,75,76,54,55,56,0,0},
  {66,8,65,67,75,76,77,55,56,57,0,0},
  {67,8,66,68,76,77,78,56,57,58,0,0},
  {68,8,67,69,77,78,79,57,58,59,0,0},
  {69,8,68,70,78,79,80,58,59,60,0,0},
  {70,8,69,71,79,80,81,59,60,61,0,0},
  {71,8,70,72,80,81,82,60,61,62,0,0},
  {72,8,71,73,81,82,83,61,62,63,0,0},
  {73,8,72,74,82,83,84,62,63,64,0,0},
  {74,8,73,75,83,84,85,63,64,65,0,0},
  {75,8,74,76,84,85,86,64,65,66,0,0},
  {76,8,75,77,85,86,87,65,66,67,0,0},
  {77,8,76,78,86,87,88,66,67,68,0,0},
  {78,8,77,79,87,88,89,67,68,69,0,0},
  {79,8,78,80,88,89,90,68,69,70,0,0},
  {80,8,79,81,89,90,91,69,70,71,0,0},
  {81,8,80,82,90,91,92,70,71,72,0,0},
  {82,8,81,83,91,92,93,71,72,73,0,0},
  {83,8,82,84,92,93,94,72,73,74,0,0},
  {84,8,83,85,93,94,95,73,74,75,0,0},
  {85,8,84,86,94,95,96,74,75,76,0,0},
  {86,8,85,87,95,96,97,75,76,77,0,0},
  {87,8,86,88,96,97,98,76,77,78,0,0},
  {88,8,87,89,97,98,99,77,78,79,0,0},
  {89,8,88,90,98,99,100,78,79,80,0,0},
  {90,8,89,91,99,100,101,79,80,81,0,0},
  {91,8,90,92,100,101,102,80,81,82,0,0},
  {92,8,91,93,101,102,103,81,82,83,0,0},
  {93,8,92,94,102,103,104,82,83,84,0,0},
  {94,8,93,95,103,104,105,83,84,85,0,0},
  {95,8,94,96,104,105,106,84,85,86,0,0},
  {96,8,95,97,105,106,107,85,86,87,0,0},
  {97,8,96,98,106,107,108,86,87,88,0,0},
  {98,8,97,99,107,108,109,87,88,89,0,0},
  {99,8,98,100,108,109,110,88,89,90,0,0},
  {100,8,99,101,109,110,111,89,90,91,0,0}
#endif  
};

bool IsMyNeighboor(uint8_t MyID, uint8_t MyNeighBoor)
{
	unsigned char i,j ;

	for (i = 0; i < 100; i++)
	{
		if (neighboorstable[i].idx == MyID)
		{
			for (j = 0; j < neighboorstable[i].nridx; j++){
				if (MyNeighBoor == neighboorstable[i].neighboors[j]) {
					return TRUE;
				}
			}
		}
	}

	return FALSE;
}

bool topology_isAcceptablePacket(ieee802154_header_iht* ieee802514_header) {
#ifdef PLUGFEST
   bool returnVal;

   returnVal=FALSE;

   if (IsMyNeighboor(idmanager_getMyID(ADDR_64B)->addr_64b[7],ieee802514_header->src.addr_64b[7])) 
   {
  	 returnVal=TRUE;
   }
   return returnVal;

#else
   return TRUE;
#endif
}

//=========================== private =========================================